{% extends 'base.html' %}
{% block title %}Configuración del sistema{% endblock %}

{% block content %}
<div class="card shadow p-4">
  <h3 class="mb-4"><i class="bi bi-gear-fill me-2"></i>Configuración del Sistema</h3>

  <form id="configForm" method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="nombreNegocio" class="form-label">
        <i class="bi bi-shop me-1"></i>Nombre del negocio
      </label>
      <input type="text" class="form-control" id="nombreNegocio" name="NombreNegocio"
             value="{{ config.get('NombreNegocio','') }}" required>
    </div>

    <div class="mb-3">
      <label for="logoFile" class="form-label">
        <i class="bi bi-image me-1"></i>Logo del negocio
      </label>
      <input type="file" class="form-control" id="logoFile" name="LogoArchivo" accept="image/*">
      <div class="mt-2">
        {% if logo_exists %}
          <img src="{{ logo_url }}" alt="Logo actual" style="height:80px;">
        {% endif %}
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label"><i class="bi bi-palette me-1"></i>Color principal</label>
      <input type="color" class="form-control form-control-color" id="colorPrincipal"
             name="ColorPrincipal" value="{{ config.get('ColorPrincipal','#0d6efd') }}">
    </div>

    <div class="mb-3">
      <label class="form-label"><i class="bi bi-brush me-1"></i>Color de fondo</label>
      <input type="color" class="form-control form-control-color" id="colorFondo"
             name="ColorFondo" value="{{ config.get('ColorFondo','#ffffff') }}">
    </div>

    <div class="d-flex justify-content-between">
      <button type="button" class="btn btn-secondary" onclick="history.back()">
        <i class="bi bi-x-circle me-1"></i>Cancelar
      </button>
      <button type="submit" class="btn btn-success" id="btnGuardar">
        <i class="bi bi-check-circle me-1"></i>Guardar
      </button>
    </div>
  </form>
</div>

<script>
document.getElementById('configForm').addEventListener('submit', async e => {
  e.preventDefault();
  const btn = document.getElementById('btnGuardar');
  btn.disabled = true;
  btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Guardando...';

  const form = e.target;
  const data = new FormData();
  data.append('NombreNegocio', form.NombreNegocio.value);
  data.append('ColorPrincipal', form.ColorPrincipal.value);
  data.append('ColorFondo', form.ColorFondo.value);
  if (document.getElementById('logoFile').files[0]) {
    data.append('LogoArchivo', document.getElementById('logoFile').files[0]);
  }

  try {
    const response = await fetch('/configuracion', {
      method: 'POST',
      body: data
    });
    if (!response.ok) throw new Error(response.statusText);
    alert('✅ Configuración actualizada con éxito');
    window.location.reload();
  } catch (err) {
    console.error(err);
    alert('❌ Ocurrió un error al guardar: ' + err.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Guardar';
  }
});
</script>
{% endblock %}
