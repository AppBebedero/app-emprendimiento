{% extends 'base.html' %}

{% block title %}Configuración del sistema{% endblock %}

{% block content %}
<h3 class="mb-4"><i class="bi bi-gear-fill me-2"></i>Configuración del Sistema</h3>

<form id="configForm">
  <div class="mb-3">
    <label for="nombreNegocio" class="form-label"><i class="bi bi-shop me-1"></i>Nombre del negocio</label>
    <input type="text" class="form-control" id="nombreNegocio" name="NombreNegocio" value="{{ config.get('NombreNegocio', '') }}" required>
  </div>

  <div class="mb-3">
    <label for="logoFile" class="form-label"><i class="bi bi-image me-1"></i>Logo del negocio</label>
    <input type="file" class="form-control" id="logoFile" accept="image/*">
    <img id="logoPreview" src="{{ config.get('LogoURL', '') }}" alt="Logo actual" style="max-height:100px; margin-top:10px;">
  </div>

  <div class="mb-3">
    <label for="colorPrincipal" class="form-label"><i class="bi bi-palette-fill me-1"></i>Color principal</label>
    <input type="color" class="form-control form-control-color" id="colorPrincipal" name="ColorPrincipal" value="{{ config.get('ColorPrincipal', '#0d6efd') }}">
  </div>

  <div class="mb-3">
    <label for="colorFondo" class="form-label"><i class="bi bi-palette me-1"></i>Color de fondo</label>
    <input type="color" class="form-control form-control-color" id="colorFondo" name="ColorFondo" value="{{ config.get('ColorFondo', '#ffffff') }}">
  </div>

  <div class="d-flex justify-content-between mt-4">
    <a href="/" class="btn btn-secondary"><i class="bi bi-x-circle me-1"></i>Cancelar</a>
    <button type="submit" class="btn btn-success"><i class="bi bi-save me-1"></i>Guardar cambios</button>
  </div>
</form>

<script>
  let logoURL = "{{ config.get('LogoURL', '') }}";

  document.getElementById('logoFile').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onloadend = async function () {
      const base64 = reader.result.split(',')[1];

      const formData = new FormData();
      formData.append('imagen', base64);
      formData.append('nombre', file.name);
      formData.append('tipo', file.type);

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbwMJmLtiv2cCtp2Qd8EqfERtZp-962oF8xTAMOXdJ-U3k1aa7oVYXcROMclP6UV9OQ/exec", {
          method: 'POST',
          body: formData
        });

        const respuesta = await response.text();
        const urlMatch = respuesta.match(/https?:\/\/[^\s]+/);
        if (urlMatch) {
          logoURL = urlMatch[0];
          document.getElementById('logoPreview').src = logoURL;

          // actualizar visualmente en topbar
          const img = document.querySelector('.navbar-brand img');
          if (img) {
            img.src = logoURL;
          } else {
            const logoImg = document.createElement('img');
            logoImg.src = logoURL;
            logoImg.style.height = "30px";
            logoImg.style.marginRight = "0.5rem";
            document.querySelector('.navbar-brand').prepend(logoImg);
          }
        }
      } catch (err) {
        alert("❌ No se pudo subir el logo.");
        console.error(err);
      }
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('configForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const form = e.target;
    const data = {
      NombreNegocio: form.NombreNegocio.value,
      LogoURL: logoURL,
      ColorPrincipal: form.ColorPrincipal.value,
      ColorFondo: form.ColorFondo.value
    };

    const boton = form.querySelector('button[type="submit"]');
    boton.disabled = true;
    boton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';

    try {
      const response = await fetch("{{ config.get('URLScriptConfig') }}", {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const resultado = await response.text();
      console.log("Respuesta:", resultado);

      // Aplicar colores y nombre visualmente
      document.body.style.backgroundColor = data.ColorFondo;
      const top = document.querySelector('.navbar');
      const bot = document.querySelector('.bottom-bar');
      if (top) top.style.backgroundColor = data.ColorPrincipal;
      if (bot) bot.style.backgroundColor = data.ColorPrincipal;

      const nombreSpan = document.querySelector('.navbar-brand span');
      if (nombreSpan) nombreSpan.textContent = data.NombreNegocio;

      alert("✅ Cambios guardados correctamente.");
    } catch (error) {
      console.error("Error:", error);
      alert("❌ Ocurrió un error al guardar.");
    } finally {
      boton.disabled = false;
      boton.innerHTML = '<i class="bi bi-save me-1"></i>Guardar cambios';
    }
  });
</script>
{% endblock %}
