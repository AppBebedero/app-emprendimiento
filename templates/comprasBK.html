{% extends "base.html" %}
{% block title %}Registrar Compras{% endblock %}

{% block content %}
<div class="container-fluid mt-4 mb-5">
  <div class="card shadow p-4">
    <h2 class="mb-4 text-center">üßæ Registrar Compra</h2>

    {% if mensaje %}
      <div class="alert alert-success text-center">{{ mensaje }}</div>
    {% endif %}

    <form method="POST" id="form-compras">
      <div class="row mb-3">
        <div class="col-md-6">
          <label><i class="bi bi-calendar-date me-1"></i>Fecha:</label>
          <input type="date" name="Fecha" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label><i class="bi bi-receipt me-1"></i>N¬∞ Documento:</label>
          <input type="text" name="N_Documento" class="form-control" required>
        </div>
      </div>

      <div class="mb-3">
        <label><i class="bi bi-person-vcard me-1"></i>Proveedor:</label>
        <div class="input-group">
          <select name="Proveedor" id="proveedor" class="form-select" required></select>
          <button type="button" class="btn btn-outline-secondary" onclick="abrirModalProveedor()">+</button>
        </div>
      </div>

      <div class="mb-3">
        <label><i class="bi bi-box me-1"></i>Producto:</label>
        <div class="input-group">
          <select name="Producto" id="producto" class="form-select" required></select>
          <button type="button" class="btn btn-outline-secondary" onclick="abrirModalProducto()">+</button>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-4">
          <label><i class="bi bi-sort-numeric-up me-1"></i>Cantidad:</label>
          <input type="number" name="Cantidad" step="any" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label><i class="bi bi-currency-exchange me-1"></i>Precio Unitario:</label>
          <input type="number" name="PrecioUnitario" step="any" class="form-control" required>
        </div>
        <div class="col-md-4">
          <label><i class="bi bi-cash-coin me-1"></i>Moneda:</label>
          <select name="Moneda" class="form-select" required>
            <option value="‚Ç°">‚Ç°</option>
            <option value="$">$</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label><i class="bi bi-credit-card me-1"></i>Forma de Pago:</label>
        <select name="Forma_Pago" class="form-select" required>
          {% for forma in formas_pago %}
            <option value="{{ forma }}">{{ forma }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3">
        <label><i class="bi bi-chat-left-dots me-1"></i>Observaciones:</label>
        <textarea name="Observaciones" class="form-control" rows="2"></textarea>
      </div>

      <div class="text-center d-flex justify-content-center gap-2 mt-4 flex-wrap">
        <a href="/" class="btn btn-danger">
          <i class="bi bi-x-circle me-1"></i>Cancelar
        </a>
        <button type="submit" class="btn btn-success px-4" id="btnGuardarCompra">
          <i class="bi bi-check-circle me-1"></i>Guardar
        </button>
      </div>
      <div id="mensajeCompra" class="text-center mt-3"></div>
    </form>
  </div>
</div>

<!-- Modal Proveedor -->
<div class="modal fade" id="modalProveedor" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-vcard me-2"></i>Nuevo Proveedor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="formProveedor">
        <div class="modal-body">
          <div class="mb-2"><label><i class="bi bi-person-fill me-1"></i>Nombre:</label><input name="nombre" class="form-control" required></div>
          <div class="mb-2"><label><i class="bi bi-telephone me-1"></i>Tel√©fono:</label><input name="telefono" id="telefono" class="form-control"></div>
          <div class="mb-2"><label><i class="bi bi-envelope me-1"></i>Email:</label><input name="email" class="form-control"></div>
          <div class="mb-2"><label><i class="bi bi-person-lines-fill me-1"></i>Contacto:</label><input name="contacto" class="form-control"></div>
          <div class="mb-2"><label><i class="bi bi-phone me-1"></i>Celular:</label><input name="celular" id="celular" class="form-control"></div>
          <div class="mb-2"><label><i class="bi bi-briefcase me-1"></i>Tipo de Negocio:</label>
            <select name="tipo_negocio" class="form-select" id="tipo_negocio" required></select>
          </div>
          <div class="mb-2"><label><i class="bi bi-chat-left-dots me-1"></i>Observaciones:</label><textarea name="observaciones" class="form-control"></textarea></div>
          <div id="errorProveedor" class="text-danger small mt-2"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Cancelar</button>
          <button type="submit" class="btn btn-success"><i class="bi bi-check-circle me-1"></i>Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Producto -->
<div class="modal fade" id="modalProducto" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-box-seam me-2"></i>Nuevo Producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="formProducto">
        <div class="modal-body">
          <div class="mb-2"><label><i class="bi bi-box me-1"></i>Nombre:</label><input name="nombre" class="form-control" required></div>
          <div class="mb-2"><label><i class="bi bi-person-vcard me-1"></i>Proveedor:</label>
            <select name="proveedor" class="form-select" id="producto_proveedor" required></select>
          </div>
          <div class="mb-2"><label><i class="bi bi-tags me-1"></i>Categor√≠a:</label>
            <select name="categoria" class="form-select" id="categoria" required></select>
          </div>
          <div class="mb-2"><label><i class="bi bi-upc-scan me-1"></i>Unidad:</label>
            <select name="unidad" class="form-select" id="unidad" required></select>
          </div>
          <div class="mb-2"><label><i class="bi bi-chat-left-text me-1"></i>Observaciones:</label>
            <textarea name="observaciones" class="form-control"></textarea>
          </div>
          <div id="errorProducto" class="text-danger small mt-2"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-danger" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i>Cancelar</button>
          <button type="submit" class="btn btn-success"><i class="bi bi-check-circle me-1"></i>Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>

<script>
function abrirModalProveedor() {
  document.getElementById('formProveedor').reset();
  document.getElementById('errorProveedor').textContent = '';
  new bootstrap.Modal(document.getElementById('modalProveedor')).show();
}

function abrirModalProducto() {
  document.getElementById('formProducto').reset();
  document.getElementById('errorProducto').textContent = '';
  new bootstrap.Modal(document.getElementById('modalProducto')).show();
}

document.addEventListener('DOMContentLoaded', async () => {
  const res = await fetch('/datos_formulario');
  const datos = await res.json();

  // Proveedores
  const proveedorSelects = [document.getElementById('proveedor'), document.getElementById('producto_proveedor')];
  proveedorSelects.forEach(select => {
    select.innerHTML = datos.proveedores.map(p => `<option value="${p.Nombre}">${p.Nombre}</option>`).join('');
  });

  // Productos
  document.getElementById('producto').innerHTML =
    datos.productos.map(p => `<option value="${p.Nombre}">${p.Nombre}</option>`).join('');

  // Tipo de Negocio
  document.getElementById('tipo_negocio').innerHTML =
    datos.tipos_negocio.map(t => `<option value="${t}">${t}</option>`).join('');

  // Categor√≠as
  document.getElementById('categoria').innerHTML =
    datos.categorias.map(c => `<option value="${c}">${c}</option>`).join('');

  // Unidades
  document.getElementById('unidad').innerHTML =
    datos.unidades.map(u => `<option value="${u}">${u}</option>`).join('');

  // M√°scaras
  $('#telefono').inputmask('9999-9999');
  $('#celular').inputmask('9999-9999');
});

// Env√≠o de formulario principal
document.getElementById('form-compras').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  const mensaje = document.getElementById('mensajeCompra');
  const btn = document.getElementById('btnGuardarCompra');

  mensaje.innerHTML = '<span class="text-primary">Guardando...</span>';
  btn.disabled = true;

  try {
    const res = await fetch('/compras', {
      method: 'POST',
      body: data
    });

    if (res.ok) {
      mensaje.innerHTML = '<span class="text-success">‚úÖ Guardado correctamente</span>';
      form.reset();
    } else {
      mensaje.innerHTML = '<span class="text-danger">‚ùå Error al guardar</span>';
      console.error(await res.text());
    }
  } catch (err) {
    mensaje.innerHTML = '<span class="text-danger">‚ùå Error de conexi√≥n</span>';
    console.error(err);
  } finally {
    btn.disabled = false;
  }
});

// Modal: Guardar nuevo proveedor
document.getElementById('formProveedor').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  const error = document.getElementById('errorProveedor');

  error.textContent = 'Guardando...';

  try {
    const res = await fetch('/nuevo_proveedor', {
      method: 'POST',
      body: data
    });
    const result = await res.json();

    if (res.ok) {
      const nuevo = data.get('nombre');
      const selects = [document.getElementById('proveedor'), document.getElementById('producto_proveedor')];
      selects.forEach(s => s.insertAdjacentHTML('beforeend', `<option value="${nuevo}">${nuevo}</option>`));
      selects.forEach(s => s.value = nuevo);
      bootstrap.Modal.getInstance(document.getElementById('modalProveedor')).hide();
    } else {
      error.textContent = result.error || '‚ùå Error al guardar';
    }
  } catch (err) {
    error.textContent = '‚ùå Error de conexi√≥n';
    console.error(err);
  }
});

// Modal: Guardar nuevo producto
document.getElementById('formProducto').addEventListener('submit', async e => {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);
  const error = document.getElementById('errorProducto');

  error.textContent = 'Guardando...';

  try {
    const res = await fetch('/nuevo_producto', {
      method: 'POST',
      body: data
    });
    const result = await res.json();

    if (res.ok) {
      const nuevo = data.get('nombre');
      const select = document.getElementById('producto');
      select.insertAdjacentHTML('beforeend', `<option value="${nuevo}">${nuevo}</option>`);
      select.value = nuevo;
      bootstrap.Modal.getInstance(document.getElementById('modalProducto')).hide();
    } else {
      error.textContent = result.error || '‚ùå Error al guardar';
    }
  } catch (err) {
    error.textContent = '‚ùå Error de conexi√≥n';
    console.error(err);
  }
});
</script>
{% endblock %}
